from __future__ import annotations

from typing import Any

import os

import httpx


# Keep explicit names for validator/tooling checks.
OPENAI_BASE_URL_ENV = "OPENAI_BASE_URL"
IWA_TASK_ID_HEADER = "IWA-Task-ID"


def is_sandbox_gateway_base_url(base_url: str) -> bool:
    """Return True when base_url looks like the local validator gateway."""
    try:
        url = httpx.URL((base_url or "").strip())
        host = (url.host or "").lower()
        return host in {"sandbox-gateway", "localhost", "127.0.0.1"}
    except Exception:
        return False


def gateway_headers(*, task_id: str, api_key: str | None = None) -> dict[str, str]:
    """Build OpenAI-compatible headers with mandatory IWA task correlation."""
    headers: dict[str, str] = {
        "Content-Type": "application/json",
        IWA_TASK_ID_HEADER: str(task_id),
    }
    if api_key:
        headers["Authorization"] = f"Bearer {api_key}"
    return headers


def chat_completions(
    *,
    task_id: str,
    body: dict[str, Any],
    base_url: str | None = None,
    api_key: str | None = None,
    timeout_seconds: float = 30.0,
) -> dict[str, Any]:
    """Call OpenAI-compatible `/chat/completions` through a gateway.

    This utility is intentionally generic and can be copied into miner projects.
    It does not implement any planning/execution logic.
    """
    resolved_base_url = (base_url or os.getenv(OPENAI_BASE_URL_ENV, "https://api.openai.com/v1")).rstrip("/")
    resolved_api_key = api_key if api_key is not None else os.getenv("OPENAI_API_KEY", "")

    if not resolved_api_key and not is_sandbox_gateway_base_url(resolved_base_url):
        raise RuntimeError("OPENAI_API_KEY not set and OPENAI_BASE_URL is not a local sandbox gateway")

    headers = gateway_headers(task_id=task_id, api_key=resolved_api_key or None)
    url = f"{resolved_base_url}/chat/completions"

    with httpx.Client(timeout=float(timeout_seconds)) as client:
        resp = client.post(url, json=body, headers=headers)
        try:
            resp.raise_for_status()
        except httpx.HTTPStatusError as exc:
            snippet = (exc.response.text or "")[:300]
            raise RuntimeError(f"chat/completions failed ({exc.response.status_code}): {snippet}") from exc
        return resp.json()
